generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// TENANT (Hospital / Clinica â€” o cliente SaaS)
// ============================================================
model Tenant {
  id        String   @id @default(cuid())
  name      String   // Nome do hospital/clinica
  cnpj      String   @unique
  plan      Plan     @default(ESSENCIAL)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lastOsNumber Int      @default(0)

  users          User[]
  units          Unit[]
  equipments     Equipment[]
  providers      Provider[]
  equipmentTypes EquipmentType[]
  contracts      Contract[]
  serviceOrders      ServiceOrder[]
  checklistTemplates ChecklistTemplate[]
  checklistResults   ChecklistResult[]
  integrationConfigs IntegrationConfig[]
  trainings          Training[]
  trainingCompletions TrainingCompletion[]

  @@map("tenants")
}

enum Plan {
  ESSENCIAL
  PROFISSIONAL
  ENTERPRISE
}

// ============================================================
// USER (Usuario do sistema)
// ============================================================
model User {
  id        String   @id @default(cuid())
  tenantId  String?
  name      String
  email     String   @unique
  password  String
  role      UserRole @default(COORDENADOR)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Unidades que o usuario pode acessar
  units UserUnit[]

  // Chamados abertos pelo usuario (coordenador)
  openedTickets CorrectiveMaintenance[] @relation("TicketOpener")
  // Chamados atendidos pelo usuario (tecnico)
  assignedTickets CorrectiveMaintenance[] @relation("TicketAssignee")
  // Treinamentos concluidos
  trainingCompletions TrainingCompletion[]

  @@index([tenantId])
  @@map("users")
}

enum UserRole {
  PLATFORM_ADMIN
  MASTER
  TECNICO
  COORDENADOR
  FISCAL
}

// ============================================================
// UNIT (Setor / Unidade de producao)
// ============================================================
model Unit {
  id        String   @id @default(cuid())
  tenantId  String
  name      String   // Ex: "UTI", "Centro Cirurgico", "Radiologia"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users      UserUnit[]
  equipments Equipment[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("units")
}

// Tabela de juncao: quais unidades cada usuario pode acessar
model UserUnit {
  userId String
  unitId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@id([userId, unitId])
  @@index([unitId])
  @@map("user_units")
}

// ============================================================
// PROVIDER (Fornecedor de servicos)
// ============================================================
model Provider {
  id            String   @id @default(cuid())
  tenantId      String
  name          String
  cnpj          String?
  phone         String?
  email         String?
  contactPerson String?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contracts Contract[]

  preventiveMaintenances PreventiveMaintenance[]
  medicalPhysicsTests    MedicalPhysicsTest[]

  // Default provider relationships for equipment types
  equipmentTypesPreventiva  EquipmentType[] @relation("DefaultPreventivaProvider")
  equipmentTypesCalibracao  EquipmentType[] @relation("DefaultCalibracaoProvider")
  equipmentTypesTse         EquipmentType[] @relation("DefaultTseProvider")

  @@index([tenantId])
  @@map("providers")
}

// ============================================================
// EQUIPMENT TYPE (Tipo de equipamento com periodicidades padrao)
// ============================================================
model EquipmentType {
  id                     String      @id @default(cuid())
  tenantId               String
  name                   String
  defaultCriticality     Criticality @default(C)
  preventivaPeriodicity  Periodicity @default(ANUAL)
  calibracaoPeriodicity  Periodicity @default(ANUAL)
  tsePeriodicity         Periodicity @default(ANUAL)
  reserveCount           Int         @default(0)
  createdAt              DateTime    @default(now())
  updatedAt              DateTime    @updatedAt

  tenant                    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  defaultPreventivaProvider Provider? @relation("DefaultPreventivaProvider", fields: [defaultPreventivaProviderId], references: [id], onDelete: SetNull)
  defaultCalibracaoProvider Provider? @relation("DefaultCalibracaoProvider", fields: [defaultCalibracaoProviderId], references: [id], onDelete: SetNull)
  defaultTseProvider        Provider? @relation("DefaultTseProvider", fields: [defaultTseProviderId], references: [id], onDelete: SetNull)

  defaultPreventivaProviderId String?
  defaultCalibracaoProviderId String?
  defaultTseProviderId        String?

  equipments         Equipment[]
  checklistTemplates ChecklistTemplate[]
  trainings          Training[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([defaultPreventivaProviderId])
  @@index([defaultCalibracaoProviderId])
  @@index([defaultTseProviderId])
  @@map("equipment_types")
}

enum ServiceType {
  PREVENTIVA
  CALIBRACAO
  TSE
}

enum Periodicity {
  TRIMESTRAL
  SEMESTRAL
  ANUAL
  BIENAL
  QUINQUENAL
  NAO_APLICAVEL
}

enum OwnershipType {
  PROPRIO
  COMODATO
}

enum DepreciationMethod {
  LINEAR
  ACELERADA
}

// ============================================================
// EQUIPMENT (Equipamento medico)
// ============================================================
model Equipment {
  id               String          @id @default(cuid())
  tenantId         String
  unitId           String
  equipmentTypeId  String?
  name             String
  brand            String?         // Marca
  model            String?         // Modelo
  serialNumber     String?         // Numero de serie
  patrimony        String?         // Patrimonio
  criticality      Criticality     @default(C)
  status           EquipmentStatus @default(ATIVO)
  ownershipType    OwnershipType   @default(PROPRIO)
  loanProvider     String?         // Fornecedor comodato (texto livre)
  acquisitionDate  DateTime?
  acquisitionValue Decimal?        // Valor de aquisicao (precisao financeira)
  vidaUtilAnos         Int?                @default(10)    // Vida util em anos
  metodoDepreciacao    DepreciationMethod  @default(LINEAR)
  valorResidual        Decimal?            // Valor residual apos depreciacao
  photoUrl         String?
  deactivationDate   DateTime?
  deactivationReason String?
  lastConferenceDate DateTime?
  conferenceNotes    String?
  externalId         String?         // ID no sistema de origem (ex: Tasy)
  externalSource     String?         // Sistema de origem (ex: "TASY")
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  unit          Unit           @relation(fields: [unitId], references: [id], onDelete: Cascade)
  equipmentType EquipmentType? @relation(fields: [equipmentTypeId], references: [id], onDelete: SetNull)

  preventiveMaintenances PreventiveMaintenance[]
  correctiveMaintenances CorrectiveMaintenance[]
  medicalPhysicsTests    MedicalPhysicsTest[]
  contractEquipments     ContractEquipment[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([unitId])
  @@index([equipmentTypeId])
  @@index([tenantId, externalSource, externalId])
  @@map("equipments")
}

enum Criticality {
  A
  B
  C
}

enum EquipmentStatus {
  ATIVO
  INATIVO
  EM_MANUTENCAO
  DESCARTADO
}

// ============================================================
// PREVENTIVE MAINTENANCE (Calibracao / Preventiva / TSE)
// ============================================================
model PreventiveMaintenance {
  id                String            @id @default(cuid())
  tenantId          String
  equipmentId       String
  type              String            // Legado: "Calibracao", "Teste de Seguranca Eletrica", etc.
  serviceType       ServiceType       @default(PREVENTIVA)
  scheduledDate     DateTime          // Data agendada
  dueDate           DateTime          // Data de vencimento
  executionDate     DateTime?         // Data em que foi realizada
  status            MaintenanceStatus @default(AGENDADA)
  provider          String?           // Legado: nome do fornecedor texto livre
  providerId        String?           // FK para Provider
  cost              Decimal?          // Valor do servico (precisao financeira)
  certificateUrl    String?           // URL do certificado anexado
  notes             String?
  periodicityMonths Int               @default(12) // Periodicidade em meses
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  equipment        Equipment         @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  providerRef      Provider?         @relation(fields: [providerId], references: [id], onDelete: SetNull)
  serviceOrder     ServiceOrder?
  checklistResults ChecklistResult[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, status, dueDate])
  @@index([tenantId, serviceType])
  @@index([equipmentId])
  @@index([dueDate])
  @@index([providerId])
  @@map("preventive_maintenances")
}

enum MaintenanceStatus {
  AGENDADA
  REALIZADA
  VENCIDA
}

// ============================================================
// CORRECTIVE MAINTENANCE (Chamado / Corretiva)
// ============================================================
model CorrectiveMaintenance {
  id            String       @id @default(cuid())
  tenantId      String
  equipmentId   String
  openedById    String       // Coordenador que abriu
  assignedToId  String?      // Tecnico que atendeu
  description   String       // Descricao do problema
  urgency       Urgency      @default(MEDIA)
  status        TicketStatus @default(ABERTO)
  diagnosis     String?      // Diagnostico do tecnico
  solution      String?      // O que foi feito
  partsUsed     String?      // Pecas utilizadas
  timeSpent     Int?         // Tempo gasto em minutos
  cost          Decimal?     // Custo do reparo (precisao financeira)
  openedAt      DateTime     @default(now())
  closedAt      DateTime?
  updatedAt     DateTime     @updatedAt

  equipment    Equipment     @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  openedBy     User          @relation("TicketOpener", fields: [openedById], references: [id], onDelete: Restrict)
  assignedTo   User?         @relation("TicketAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  serviceOrder ServiceOrder?

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([equipmentId])
  @@index([openedById])
  @@index([assignedToId])
  @@map("corrective_maintenances")
}

enum Urgency {
  BAIXA
  MEDIA
  ALTA
  CRITICA
}

enum TicketStatus {
  ABERTO
  EM_ATENDIMENTO
  RESOLVIDO
  FECHADO
}

// ============================================================
// MEDICAL PHYSICS TEST (Fisica Medica)
// ============================================================
model MedicalPhysicsTest {
  id                String                @id @default(cuid())
  tenantId          String
  equipmentId       String
  type              MedicalPhysicsType
  scheduledDate     DateTime
  dueDate           DateTime
  executionDate     DateTime?
  status            MaintenanceStatus     @default(AGENDADA)
  provider          String?               // Legado: empresa de fisica medica
  providerId        String?               // FK para Provider
  periodicityMonths Int                   @default(12)
  reportUrl         String?               // URL do laudo
  notes             String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  providerRef Provider? @relation(fields: [providerId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([equipmentId])
  @@index([dueDate])
  @@index([providerId])
  @@map("medical_physics_tests")
}

enum MedicalPhysicsType {
  CONTROLE_QUALIDADE
  TESTE_CONSTANCIA
  LEVANTAMENTO_RADIOMETRICO
  TESTE_RADIACAO_FUGA
}

// ============================================================
// CONTRACT (Contrato com fornecedor)
// ============================================================
model Contract {
  id          String   @id @default(cuid())
  tenantId    String
  providerId  String
  name        String
  startDate   DateTime
  endDate     DateTime
  value       Decimal? // Valor do contrato (precisao financeira)
  documentUrl String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant     Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  provider   Provider            @relation(fields: [providerId], references: [id], onDelete: Cascade)
  equipments ContractEquipment[]

  @@index([tenantId])
  @@index([providerId])
  @@map("contracts")
}

// Juncao contrato-equipamento
model ContractEquipment {
  contractId  String
  equipmentId String

  contract  Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@id([contractId, equipmentId])
  @@index([equipmentId])
  @@map("contract_equipments")
}

// ============================================================
// SERVICE ORDER (Ordem de Servico)
// ============================================================
model ServiceOrder {
  id          String      @id @default(cuid())
  tenantId    String
  number      Int         // Numero sequencial por tenant
  status      OrderStatus @default(ABERTA)
  issuedAt    DateTime    @default(now())
  completedAt DateTime?

  preventiveMaintenanceId String? @unique
  correctiveMaintenanceId String? @unique

  tenant                Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  preventiveMaintenance PreventiveMaintenance? @relation(fields: [preventiveMaintenanceId], references: [id], onDelete: Cascade)
  correctiveMaintenance CorrectiveMaintenance? @relation(fields: [correctiveMaintenanceId], references: [id], onDelete: Cascade)

  @@unique([tenantId, number])
  @@index([tenantId])
  @@index([tenantId, status])
  @@map("service_orders")
}

enum OrderStatus {
  ABERTA
  EM_EXECUCAO
  CONCLUIDA
}

// ============================================================
// CHECKLIST TEMPLATE (Template de checklist para manutencao preventiva)
// ============================================================
model ChecklistTemplate {
  id              String   @id @default(cuid())
  tenantId        String
  equipmentTypeId String
  name            String
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  equipmentType EquipmentType @relation(fields: [equipmentTypeId], references: [id], onDelete: Cascade)
  items         ChecklistItem[]
  results       ChecklistResult[]

  @@index([tenantId])
  @@index([equipmentTypeId])
  @@map("checklist_templates")
}

model ChecklistItem {
  id          String @id @default(cuid())
  templateId  String
  description String
  order       Int    @default(0)

  template    ChecklistTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  resultItems ChecklistResultItem[]

  @@index([templateId])
  @@map("checklist_items")
}

// ============================================================
// CHECKLIST RESULT (Resultado de checklist preenchido na execucao)
// ============================================================
model ChecklistResult {
  id                      String   @id @default(cuid())
  tenantId                String
  preventiveMaintenanceId String
  templateId              String
  completedAt             DateTime @default(now())
  completedById           String

  tenant                Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  preventiveMaintenance PreventiveMaintenance @relation(fields: [preventiveMaintenanceId], references: [id], onDelete: Cascade)
  template              ChecklistTemplate     @relation(fields: [templateId], references: [id], onDelete: Cascade)
  items                 ChecklistResultItem[]

  @@index([tenantId])
  @@index([preventiveMaintenanceId])
  @@map("checklist_results")
}

model ChecklistResultItem {
  id          String              @id @default(cuid())
  resultId    String
  itemId      String
  status      ChecklistItemStatus
  observation String?

  result ChecklistResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
  item   ChecklistItem   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([resultId])
  @@map("checklist_result_items")
}

enum ChecklistItemStatus {
  CONFORME
  NAO_CONFORME
}

// ============================================================
// Integracoes ERP
// ============================================================

enum IntegrationProvider {
  TASY
}

model IntegrationConfig {
  id             String              @id @default(cuid())
  tenantId       String
  provider       IntegrationProvider
  apiUrl         String
  apiToken       String
  enabled        Boolean             @default(true)
  lastSyncAt     DateTime?
  lastSyncResult Json?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider])
  @@index([tenantId])
  @@map("integration_configs")
}

// ============================================================
// TREINAMENTOS
// ============================================================

model Training {
  id              String         @id @default(cuid())
  tenantId        String
  title           String
  description     String?
  equipmentTypeId String?
  videoUrl        String?
  validityMonths  Int            @default(12)
  active          Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  equipmentType EquipmentType? @relation(fields: [equipmentTypeId], references: [id], onDelete: SetNull)
  completions   TrainingCompletion[]

  @@index([tenantId])
  @@map("trainings")
}

model TrainingCompletion {
  id          String   @id @default(cuid())
  tenantId    String
  trainingId  String
  userId      String
  completedAt DateTime @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  training Training @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([trainingId, userId])
  @@index([tenantId])
  @@index([userId])
  @@map("training_completions")
}
